import json
import uuid
from pathlib import Path
from unittest.mock import MagicMock

import pytest
from fastapi import UploadFile

from app.dependencies.entitysdk import get_client

ROUTE = "/declared/morphology-metrics-entity-registration"

VIRTUAL_LAB_ID = "bf7d398c-b812-408a-a2ee-098f633f7798"
PROJECT_ID = "100a9a8a-5229-4f3d-aef3-6a4184c59e74"


# --- Fixtures for Mock Data ---


@pytest.fixture
def mock_entity_payload():
    """Returns a mock JSON string payload for the entity metadata."""
    payload_data = {
        "name": "Test Morphology Analysis Name",
        "description": "Mock description for test run.",
        "subject_id": str(uuid.uuid4()),
        "brain_region_id": str(uuid.uuid4()),
        "brain_location": [100.0, 200.0, 300.0],
        "cell_morphology_protocol_id": str(uuid.uuid4()),
    }
    return json.dumps(payload_data)


@pytest.fixture
def mock_morphology_file():
    """Returns a mock UploadFile object for the SWC file upload."""
    mock_file = MagicMock()
    upload_file = UploadFile(
        filename="test_morphology.swc",
        file=mock_file,
    )
    return upload_file


@pytest.fixture
def mock_temp_file_path():
    """Returns a mock path object for the temporary SWC file."""
    return Path("/non/existent/mock_temp_file.swc")


@pytest.fixture
def mock_measurement_list():
    """Returns a mock list of measurements generated by the analysis."""
    return [
        {"name": "total_length", "value": 500.0, "unit": "um", "domain": "soma"},
        {"name": "n_sections", "value": 10, "unit": "count", "domain": "apical_dendrite"},
    ]


# --- Auto-mock heavy template and analysis dict to prevent OOM ---
@pytest.fixture(autouse=True)
def mock_template_and_analysis(monkeypatch):
    """Mock _get_template and _get_analysis_dict to return minimal data."""

    def mock_get_template():
        return {
            "data": [
                {
                    "entity_id": None,
                    "entity_type": "reconstruction_morphology",
                    "measurement_kinds": [
                        {
                            "structural_domain": "soma",
                            "pref_label": "test_metric",
                            "measurement_items": [{"name": "raw", "unit": "Î¼m", "value": None}],
                        }
                    ],
                }
            ],
            "pagination": {"page": 1, "page_size": 100, "total_items": 1},
            "facets": None,
        }

    def mock_get_analysis_dict():
        return {
            "soma": {
                "test_metric": lambda _: 42.0  # Use _ to avoid ARG005
            }
        }

    monkeypatch.setattr(
        "app.endpoints.morphology_metrics_calculation._get_template", mock_get_template
    )
    monkeypatch.setattr(
        "app.endpoints.morphology_metrics_calculation._get_analysis_dict", mock_get_analysis_dict
    )


# --- Test Case ---


def test_morphology_registration_success(
    client,
    monkeypatch,
    mock_entity_payload,
    mock_temp_file_path,
    mock_measurement_list,
    mock_morphology_file,
):
    """Tests the successful registration and metrics calculation pipeline."""
    # 1. Setup Mock EntitySDK Client
    entitysdk_client_mock = MagicMock()
    monkeypatch.setitem(client.app.dependency_overrides, get_client, lambda: entitysdk_client_mock)

    # Mock the ID returned after successful entity creation
    mock_entity_id = uuid.uuid4()
    expected_morphology_name = json.loads(mock_entity_payload)["name"]

    # Return mock with .id and .name directly
    mock_registered_entity = MagicMock()
    mock_registered_entity.id = str(mock_entity_id)
    mock_registered_entity.name = expected_morphology_name

    # 2. Mock Internal Pipeline Functions
    def mock_process_and_convert(_temp_file_path, _file_extension=None):
        return str(mock_temp_file_path), None  # outputfile1, outputfile2

    monkeypatch.setattr(
        "app.endpoints.morphology_validation.process_and_convert_morphology",
        mock_process_and_convert,
    )

    # Mock analysis to return our fixture
    monkeypatch.setattr(
        "app.endpoints.morphology_metrics_calculation._run_morphology_analysis",
        lambda _path: mock_measurement_list,
    )

    # Mock entity registration
    monkeypatch.setattr(
        "app.endpoints.morphology_metrics_calculation.register_morphology",
        lambda _client, _payload: mock_registered_entity,
    )

    # Mock asset/measurement registration
    mock_register_assets_and_measurements = MagicMock()
    monkeypatch.setattr(
        "app.endpoints.morphology_metrics_calculation._register_assets_and_measurements",
        mock_register_assets_and_measurements,
    )

    # --- Configure mock UploadFile ---
    mock_morphology_file.filename = "601506507_transformed.swc"
    mock_morphology_file.file.read.return_value = b"mock swc content"

    # 3. Perform the POST Request
    response = client.post(
        ROUTE,
        data={
            "metadata": mock_entity_payload,
            "virtual_lab_id": VIRTUAL_LAB_ID,
            "project_id": PROJECT_ID,
        },
        files={"file": mock_morphology_file},
    )

    # 4. Assertions
    assert response.status_code == 200

    response_json = response.json()
    assert response_json["status"] == "success"
    assert response_json["entity_id"] == str(mock_entity_id)
    assert response_json["morphology_name"] == expected_morphology_name

    # Check registration was called
    mock_register_assets_and_measurements.assert_called_once()
    args, _ = mock_register_assets_and_measurements.call_args
    assert args[1] == str(mock_entity_id)
    assert args[4] == mock_measurement_list
